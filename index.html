<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HS / CA Code Lookup</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script>window.BRAND = { primary: "#00846C" };</script>

  <style>
    :root { color-scheme: light dark; }
    body { font-family: Aptos, "Aptos Display", "Segoe UI", system-ui, Arial, sans-serif; }

    .brand-bg { background-color: var(--brand); }
    .brand-ring { box-shadow: 0 0 0 3px color-mix(in srgb, var(--brand) 22%, transparent); }
    .thead-tint { background-color: color-mix(in srgb, var(--brand) 16%, white); }
    mark { padding: 0 2px; border-radius: 4px; background: color-mix(in srgb, var(--brand) 22%, transparent); }
    .tap { min-height: 44px; }
  </style>
</head>

<body class="bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-50">
<script>document.documentElement.style.setProperty("--brand", window.BRAND.primary);</script>

<header class="border-b bg-white/80 backdrop-blur dark:bg-slate-950/80">
  <div class="max-w-7xl mx-auto px-4 py-5 flex items-center gap-4">
    <img src="./logo.png" class="h-14 rounded-xl bg-white p-2 shadow dark:bg-slate-900" />
    <div>
      <h1 class="text-lg sm:text-2xl font-semibold">
        Look Up Your Product's HS Code and Singapore CA Code Here
      </h1>
      <p class="text-sm text-slate-600 dark:text-slate-300">
        Search by HS Code, CA Product Code, or description.
      </p>
    </div>
    <span id="statusChip" class="ml-auto hidden px-3 py-1 text-xs rounded-full text-white brand-bg">Ready</span>
  </div>
</header>

<!-- Sticky Search -->
<div class="sticky top-0 z-30 bg-slate-50/90 dark:bg-slate-950/90 border-b">
  <div class="max-w-7xl mx-auto px-4 py-3">
    <label class="text-xs text-slate-600 dark:text-slate-300">Search</label>
    <div class="relative mt-1">
      <div class="flex items-center gap-2 bg-white dark:bg-slate-900 rounded-2xl px-4 py-3 border focus-within:brand-ring">
        <input id="q" type="text"
          class="w-full bg-transparent text-base outline-none"
          placeholder="HS (01012100), CA (VBA0HO), or keywords"
          autocomplete="off" />
        <button id="clearBtn" class="tap px-3 rounded-xl border">Clear</button>
      </div>

      <div id="acBox" class="absolute hidden w-full mt-2 bg-white dark:bg-slate-900 rounded-xl shadow border z-40">
        <ul id="acList"></ul>
      </div>
    </div>

    <div class="flex justify-between mt-2 text-xs text-slate-500">
      <span>Multiple words allowed. Any word can match.</span>
      <span id="countPill" class="px-2 rounded-full" style="background:color-mix(in srgb,#00846C 14%,white)">0</span>
    </div>

    <div id="didYouMean" class="hidden mt-3 bg-white dark:bg-slate-900 border rounded-xl px-4 py-2 text-sm">
      No results. Did you mean:
      <span id="dymItems"></span>
    </div>

    <div id="loadMsg" class="text-xs mt-2 text-slate-500">Loading dataâ€¦</div>
  </div>
</div>

<main class="max-w-7xl mx-auto px-4 py-5">
  <div class="overflow-auto bg-white dark:bg-slate-900 border rounded-2xl shadow">
    <table class="min-w-full text-sm">
      <thead class="thead-tint sticky top-[104px] text-xs uppercase">
        <tr>
          <th class="px-4 py-3">HS Code</th>
          <th class="px-4 py-3">HS Description</th>
          <th class="px-4 py-3">CA Product Code</th>
          <th class="px-4 py-3 hidden md:table-cell">CA Product Description</th>
        </tr>
      </thead>
      <tbody id="rows" class="divide-y"></tbody>
    </table>
  </div>

  <div id="emptyState" class="hidden text-center mt-6 text-slate-500">
    No matching records.
  </div>
</main>

<div id="toast" class="hidden fixed bottom-6 left-1/2 -translate-x-1/2 px-4 py-2 rounded-full text-white brand-bg">
  Copied
</div>

<script>
const qEl = document.getElementById("q");
const rowsEl = document.getElementById("rows");
const acBox = document.getElementById("acBox");
const acList = document.getElementById("acList");
const didYouMean = document.getElementById("didYouMean");
const dymItems = document.getElementById("dymItems");
const countPill = document.getElementById("countPill");
const toast = document.getElementById("toast");
const clearBtn = document.getElementById("clearBtn");
const statusChip = document.getElementById("statusChip");
const loadMsg = document.getElementById("loadMsg");
const emptyState = document.getElementById("emptyState");

let data = [], filtered = [];
let suggestPool = [], suggestSet = new Set();

const norm = s => String(s||"").toLowerCase();
const pick = (r,k)=>k.map(x=>r[x]).find(v=>v)?.toString()||"";

function toastMsg(t){ toast.textContent=t; toast.classList.remove("hidden"); setTimeout(()=>toast.classList.add("hidden"),1200); }

function copy(t){ navigator.clipboard?.writeText(t); toastMsg("Copied"); }

function rowText(r){
  return [
    pick(r,["HS Code","hs"]),
    pick(r,["HS Description"]),
    pick(r,["CA Product Code"]),
    pick(r,["CA Product Description"])
  ].join(" ").toLowerCase();
}

function render(rows, tokens){
  rowsEl.innerHTML="";
  emptyState.classList.toggle("hidden", rows.length!==0);
  countPill.textContent = rows.length;
  rows.forEach(r=>{
    const hs = pick(r,["HS Code","hs"]);
    const ca = pick(r,["CA Product Code"]);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="px-4 py-2 font-semibold cursor-pointer" onclick="navigator.clipboard.writeText('${hs}')">${hs}</td>
      <td class="px-4 py-2">${pick(r,["HS Description"])}</td>
      <td class="px-4 py-2 font-semibold cursor-pointer" onclick="navigator.clipboard.writeText('${ca}')">${ca}</td>
      <td class="px-4 py-2 hidden md:table-cell">${pick(r,["CA Product Description"])}</td>`;
    rowsEl.appendChild(tr);
  });
}

function applyFilter(){
  const tokens = qEl.value.toLowerCase().split(/\s+/).filter(Boolean);
  didYouMean.classList.add("hidden");

  if(!tokens.length){ filtered=data; render(filtered); return; }

  filtered = data.filter(r=>{
    const hay = rowText(r);
    return tokens.some(t=>hay.includes(t));
  });

  render(filtered,tokens);

  if(filtered.length===0) suggest(tokens.join(""));
}

function suggest(q){
  const ranked = suggestPool
    .map(s=>({s,d:Math.abs(s.length-q.length)}))
    .sort((a,b)=>a.d-b.d)
    .slice(0,3);

  if(!ranked.length) return;
  dymItems.innerHTML="";
  ranked.forEach(x=>{
    const b=document.createElement("button");
    b.textContent=x.s;
    b.className="ml-2 px-3 py-1 rounded-full text-white brand-bg";
    b.onclick=()=>{qEl.value=x.s; applyFilter();};
    dymItems.appendChild(b);
  });
  didYouMean.classList.remove("hidden");
}

(async function(){
  const r=await fetch("./data.json");
  data=await r.json();
  data.forEach(row=>{
    Object.values(row).forEach(v=>{
      if(typeof v==="string" && v.length<40){
        const k=v.toLowerCase();
        if(!suggestSet.has(k)){suggestSet.add(k);suggestPool.push(v);}
      }
    });
  });
  statusChip.classList.remove("hidden");
  loadMsg.textContent=`Loaded ${data.length} rows`;
  filtered=data; render(data);
})();
qEl.oninput=applyFilter;
clearBtn.onclick=()=>{qEl.value=""; applyFilter();};
</script>
</body>
</html>
